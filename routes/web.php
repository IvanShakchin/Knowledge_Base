<?php

use App\Http\Controllers\ProfileController;
use App\Http\Controllers\HomeController;
use App\Http\Controllers\Admin\ArticleController;
use App\Http\Controllers\Admin\CategoryController;
use App\Http\Controllers\Admin\TagController;
use Illuminate\Support\Facades\Route;

use Illuminate\Http\Request;
use Illuminate\Support\Facades\Session;
use Illuminate\Support\Facades\Response;
use App\Http\Controllers\Admin\UserController;


// –í–æ–∑–º–æ–∂–Ω–æ —ç—Ç–∏ —Ç—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–∏–¥–µ—Ç—Å—è –∑–∞–∫–æ–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å
// use PDO;
// use RecursiveIteratorIterator;
// use RecursiveDirectoryIterator;


    //Public routes
    Route::get('/', [HomeController::class, 'index'])->name('home');
    Route::get('/search', [HomeController::class, 'search'])->name('search');
    Route::post('/search', [HomeController::class, 'search'])->name('search');
    Route::get('/category/{category:slug}', [HomeController::class, 'category'])->name('category');
    Route::get('/article/{article:slug}', [ArticleController::class, 'show'])->name('article.show');

    Route::get('/dashboard', function () {
        return view('dashboard');
    })->middleware(['auth', 'verified'])->name('dashboard');

    Route::middleware('auth')->group(function () {
        Route::get('/profile', [ProfileController::class, 'edit'])->name('profile.edit');
        Route::patch('/profile', [ProfileController::class, 'update'])->name('profile.update');
        Route::delete('/profile', [ProfileController::class, 'destroy'])->name('profile.destroy');
    });

    Route::middleware(['auth'])->prefix('admin')->name('admin.')->group(function () {
        Route::get('/', function () {
            return redirect()->route('admin.articles.index');
        })->name('index'); // –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å route('admin.index')
        
        Route::resource('articles', ArticleController::class);
        Route::resource('categories', CategoryController::class);
        Route::resource('tags', TagController::class);

        // –ú–∞—Ä—à—Ä—É—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
        Route::get('/users', [UserController::class, 'index'])->name('users.index');
        Route::patch('/users/{user}/approve', [UserController::class, 'approve'])->name('users.approve');
        Route::delete('/users/{user}/reject', [UserController::class, 'reject'])->name('users.reject');
        Route::patch('/users/{user}/make-admin', [UserController::class, 'makeAdmin'])->name('users.makeAdmin');
        Route::patch('/users/{user}/remove-admin', [UserController::class, 'removeAdmin'])->name('users.removeAdmin');
    
    });

    Route::delete('admin/articles/{article}/files/{media}', [ArticleController::class, 'destroyFile'])->name('admin.articles.files.destroy');

    Route::post('articles/{article}/restore/{history}', [ArticleController::class, 'restoreVersion'])
    ->name('admin.articles.restore');

    // –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Ä—à—Ä—É—Ç –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
    Route::get('/instructions', function () {
        return view('instructions');
    })->name('instructions'); 

    // –§—É–Ω–∫—Ü–∏—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
    function scanDirectory($dir, $basePath = '') {
        $result = [];
        $stats = ['files' => 0, 'folders' => 0];
    
        $items = scandir($dir);
        foreach($items as $item) {
            if($item == '.' || $item == '..' || in_array($item, ['vendor', 'node_modules', '.git'])) continue;
        
            $path = $dir . DIRECTORY_SEPARATOR . $item;
            $relativePath = ($basePath ? $basePath . '/' : '') . $item;
        
            if(is_dir($path)) {
                $stats['folders']++;
                $children = scanDirectory($path, $relativePath);
                $stats['files'] += $children['stats']['files'];
                $stats['folders'] += $children['stats']['folders'];
            
                $result[] = [
                    'type' => 'folder',
                    'name' => $item,
                    'path' => $relativePath,
                    'size' => round(calculateFolderSize($path) / 1024, 1),
                    'children' => $children['tree'],
                    'stats' => $children['stats']
                ];
            } else {
                $stats['files']++;
                $result[] = [
                    'type' => 'file',
                    'name' => $item,
                    'path' => $relativePath,
                    'size' => round(filesize($path) / 1024, 1)
                ];
            }
        }
    
        return ['tree' => $result, 'stats' => $stats];
    }




    

    // –§—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ —Ä–∞–∑–º–µ—Ä–∞ –ø–∞–ø–∫–∏
    function calculateFolderSize($dir) {
        $size = 0;
        $files = new RecursiveIteratorIterator(new RecursiveDirectoryIterator($dir));
        foreach($files as $file) {
            if($file->isFile() && !str_contains($file->getPathname(), '.git')) {
                $size += $file->getSize();
            }
        }
        return $size;
    }

    // –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ VCA
    // Route::match(['get', 'post'], 'vca', function (Request $request) {
    //     $accessPassword = env('VCA_ACCESS_PASSWORD', 'afyljhby');
    //     $authenticated = Session::has('vca_authenticated');

    //     if ($request->isMethod('post')) {
    //         if ($request->input('password') === $accessPassword) {
    //             Session::put('vca_authenticated', true);
    //             $authenticated = true;
    //         } else {
    //             Session::flash('error', '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!');
    //             return redirect()->route('vca.index');
    //         }
    //     }

    //     if (!$authenticated) {
    //         return view('vca.login');
    //     }

    //     return view('vca.index');
    // })->name('vca.index');

    // –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã
    // Route::post('vca/scan', function () {
    //     if (!Session::has('vca_authenticated')) {
    //         return response()->json(['error' => 'Unauthorized'], 401);
    //     }

    //     try {
    //         // –°–∫–∞–Ω–∏—Ä—É–µ–º –∫–æ—Ä–Ω–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
    //         $rootDir = base_path();
            
    //         $result = scanDirectory($rootDir);
            
    //         // –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ—Ä–Ω–µ–≤–æ–π —ç–ª–µ–º–µ–Ω—Ç
    //         $response = [
    //             'type' => 'folder',
    //             'name' => basename($rootDir),
    //             'path' => '',
    //             'size' => round(calculateFolderSize($rootDir) / 1024, 1),
    //             'children' => $result['tree'],
    //             'stats' => $result['stats']
    //         ];
            
    //         return response()->json([
    //             'tree' => [$response],
    //             'stats' => $response['stats']
    //         ]);
    //     } catch(Exception $e) {
    //         return response()->json(['error' => $e->getMessage()], 500);
    //     }
    // })->name('vca.scan');

    // –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
    // Route::post('vca/export', function (Request $request) {
    //     if (!Session::has('vca_authenticated')) {
    //         return response()->json(['error' => 'Unauthorized'], 401);
    //     }

    //     // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
    //     function renderStructure($node, $indent = 0) {
    //         $output = '';
    //         $prefix = str_repeat('  ', $indent);
        
    //         if($node['type'] === 'folder') {
    //             $output .= $prefix . "üìÅ {$node['name']} ({$node['size']} KB)\n";
            
    //             if(isset($node['children'])) {
    //                 foreach($node['children'] as $child) {
    //                     $output .= renderStructure($child, $indent + 1);
    //                 }
    //             }
    //         } else {
    //             $output .= $prefix . "üìÑ {$node['name']} ({$node['size']} KB)\n";
    //         }
        
    //         return $output;
    //     }
        
    //     try {
    //         $data = $request->json()->all();
    //         $files = $data['files'] ?? [];
    //         $structure = $data['structure'] ?? null;
    //         $includeDb = $data['includeDb'] ?? true;
        
    //         $output = "–≠–ö–°–ü–û–†–¢ –ü–†–û–ï–ö–¢–ê\n\n";
    //         $output .= "–¢–ò–ü –≠–ö–°–ü–û–†–¢–ê: " . ($includeDb ? "–° –ë–ê–ó–û–ô –î–ê–ù–ù–´–•" : "–ë–ï–ó –ë–ê–ó–´ –î–ê–ù–ù–´–•") . "\n\n";
        
    //         $output .= "================================\n";
    //         $output .= "–°–¢–†–£–ö–¢–£–†–ê –ü–†–û–ï–ö–¢–ê\n";
    //         $output .= "================================\n\n";
        
    //         if($structure && isset($structure['tree'][0])) {
    //             $output .= renderStructure($structure['tree'][0]);
    //         } else {
    //             $output .= "–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞\n";
    //         }
        
    //         $output .= "\n\n================================\n";
    //         $output .= "–°–û–î–ï–†–ñ–ò–ú–û–ï –í–´–ë–†–ê–ù–ù–´–• –§–ê–ô–õ–û–í\n";
    //         $output .= "================================\n\n";
        
    //         foreach($files as $file) {
    //             $fullPath = base_path($file);
            
    //             if(!file_exists($fullPath)) {
    //                 $output .= "–§–ê–ô–õ –ù–ï –ù–ê–ô–î–ï–ù: $file\n\n";
    //                 continue;
    //             }
            
    //             $output .= "üìÑ –§–ê–ô–õ: $file\n";
    //             $output .= "üìè –†–ê–ó–ú–ï–†: " . round(filesize($fullPath) / 1024, 1) . " KB\n";
    //             $output .= "üîç –°–û–î–ï–†–ñ–ò–ú–û–ï:\n" . file_get_contents($fullPath) . "\n\n";
    //             $output .= str_repeat('-', 50) . "\n\n";
    //         }
        
    //         if ($includeDb) {
    //             $output .= "\n\n================================\n";
    //             $output .= "–°–¢–†–£–ö–¢–£–†–ê –ë–ê–ó–´ –î–ê–ù–ù–´–•\n";
    //             $output .= "================================\n\n";
            
    //             try {
    //                 $pdo = new PDO(
    //                     "mysql:host=".env('DB_HOST').";dbname=".env('DB_DATABASE'), 
    //                     env('DB_USERNAME'), 
    //                     env('DB_PASSWORD')
    //                 );
    //                 $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
                
    //                 $tables = $pdo->query("SHOW TABLES")->fetchAll(PDO::FETCH_COLUMN);
                
    //                 foreach($tables as $table) {
    //                     $output .= "üìä –¢–ê–ë–õ–ò–¶–ê: $table\n";
                    
    //                     $columns = $pdo->query("DESCRIBE `$table`")->fetchAll(PDO::FETCH_ASSOC);
                    
    //                     foreach($columns as $col) {
    //                         $output .= "  ‚îú‚îÄ üè∑Ô∏è –ö–û–õ–û–ù–ö–ê: {$col['Field']}\n";
    //                         $output .= "  ‚îÇ  ‚îú‚îÄ –¢–ò–ü: {$col['Type']}\n";
    //                         $output .= "  ‚îÇ  ‚îú‚îÄ NULL: {$col['Null']}\n";
    //                         $output .= "  ‚îÇ  ‚îú‚îÄ –ö–õ–Æ–ß: {$col['Key']}\n";
    //                         $output .= "  ‚îÇ  ‚îú‚îÄ –ü–û –£–ú–û–õ–ß–ê–ù–ò–Æ: {$col['Default']}\n";
    //                         $output .= "  ‚îÇ  ‚îî‚îÄ –î–û–ü: {$col['Extra']}\n";
    //                     }
    //                     $output .= "\n";
    //                 }
    //             } catch(PDOException $e) {
    //                 $output .= "‚ùå –û–®–ò–ë–ö–ê –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø –ö –ë–ê–ó–ï –î–ê–ù–ù–´–•: " . $e->getMessage() . "\n";
    //             }
    //         } else {
    //             $output .= "\n\n[–≠–ö–°–ü–û–†–¢ –ë–ï–ó –°–¢–†–£–ö–¢–£–†–´ –ë–ê–ó–´ –î–ê–ù–ù–´–•]\n";
    //         }
        
    //         $fileName = $includeDb ? 'project_export_with_db.txt' : 'project_export_without_db.txt';
            
    //         return Response::make($output, 200, [
    //             'Content-Type' => 'text/plain',
    //             'Content-Disposition' => 'attachment; filename="' . $fileName . '"'
    //         ]);
    //     } catch(Exception $e) {
    //         return response('‚ùå –û–®–ò–ë–ö–ê –≠–ö–°–ü–û–†–¢–ê: ' . $e->getMessage(), 500);
    //     }
    // })->name('vca.export');

    // –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã
    // Route::get('vca/logout', function () {
    //     Session::forget('vca_authenticated');
    //     return redirect()->route('vca.index');
    // })->name('vca.logout');

require __DIR__.'/auth.php';